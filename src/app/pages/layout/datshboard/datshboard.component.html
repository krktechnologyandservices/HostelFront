<nb-layout>
  <nb-layout-column>
    <div class="dashboard-container">
      <!-- Quick Stats Header -->
      <div class="quick-stats-header">
        <div class="stats-grid">
          <div class="stat-card" (click)="scrollToSection('rooms')">
            <div class="stat-icon">
              <nb-icon icon="home-outline"></nb-icon>
            </div>
            <div class="stat-info">
              <span class="stat-number">{{ totalActiveBookings }}</span>
              <span class="stat-label">Active Bookings</span>
            </div>
          </div>
          
          <div class="stat-card" (click)="scrollToSection('students')">
            <div class="stat-icon">
              <nb-icon icon="people-outline"></nb-icon>
            </div>
            <div class="stat-info">
              <span class="stat-number">{{ students.length }}</span>
              <span class="stat-label">Total Students</span>
            </div>
          </div>
          
          <div class="stat-card" (click)="scrollToSection('payments')">
            <div class="stat-icon">
              <nb-icon icon="credit-card-outline"></nb-icon>
            </div>
            <div class="stat-info">
              <span class="stat-number">{{ todayPaymentsCount }}</span>
              <span class="stat-label">Today's Payments</span>
            </div>
          </div>
          
          <div class="stat-card" (click)="loadPayments('due')">
            <div class="stat-icon">
              <nb-icon icon="alert-triangle-outline"></nb-icon>
            </div>
            <div class="stat-info">
              <span class="stat-number">{{ totalDueAmount | currency:'INR':'symbol':'1.0-0' }}</span>
              <span class="stat-label">Total Due</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Dashboard Sections -->
      <div class="dashboard-sections">
        <!-- Rooms Dashboard -->
        <nb-card class="dashboard-section" id="rooms-section">
          <nb-card-header class="section-header" (click)="toggleSection('rooms')">
            <div class="header-content">
              <div class="title-group">
                <nb-icon icon="home-outline" class="section-icon"></nb-icon>
                <h3>Room Dashboard</h3>
                <span class="badge">{{ rooms.length }} Rooms</span>
              </div>
              <nb-icon [icon]="collapsedSections.rooms ? 'chevron-down' : 'chevron-up'" 
                       class="toggle-icon"></nb-icon>
            </div>
          </nb-card-header>
          
          <nb-card-body *ngIf="!collapsedSections.rooms">
            <div class="dashboard-body">
              <!-- Room Status Summary -->
              <div class="room-summary-cards">
                <div class="status-card vacant" (click)="filterRoomsByStatus('vacant')">
                  <div class="status-indicator"></div>
                  <div class="status-content">
                    <span class="count">{{ getVacantRoomsCount() }}</span>
                    <span class="label">Vacant Rooms</span>
                  </div>
                </div>
                
                <div class="status-card partial" (click)="filterRoomsByStatus('partial')">
                  <div class="status-indicator"></div>
                  <div class="status-content">
                    <span class="count">{{ getPartialRoomsCount() }}</span>
                    <span class="label">Partially Occupied</span>
                  </div>
                </div>
                
                <div class="status-card full" (click)="filterRoomsByStatus('full')">
                  <div class="status-indicator"></div>
                  <div class="status-content">
                    <span class="count">{{ getFullRoomsCount() }}</span>
                    <span class="label">Fully Occupied</span>
                  </div>
                </div>
              </div>

              <!-- Room Filter -->
              <div class="room-filter">
                <input type="text" 
                       [(ngModel)]="roomSearch" 
                       (input)="filterRooms()"
                       placeholder="Search rooms..." 
                       class="search-input">
                <div class="filter-buttons">
                  <button nbButton ghost size="small" 
                          [status]="currentRoomFilter === 'all' ? 'primary' : 'basic'"
                          (click)="setRoomFilter('all')">
                    All
                  </button>
                  <button nbButton ghost size="small" 
                          [status]="currentRoomFilter === 'vacant' ? 'primary' : 'basic'"
                          (click)="setRoomFilter('vacant')">
                    Vacant
                  </button>
                  <button nbButton ghost size="small" 
                          [status]="currentRoomFilter === 'partial' ? 'primary' : 'basic'"
                          (click)="setRoomFilter('partial')">
                    Partial
                  </button>
                  <button nbButton ghost size="small" 
                          [status]="currentRoomFilter === 'full' ? 'primary' : 'basic'"
                          (click)="setRoomFilter('full')">
                    Full
                  </button>
                </div>
              </div>

              <!-- Rooms Grid -->
              <div class="rooms-grid-container">
                <div class="rooms-grid">
                  <div *ngFor="let room of filteredRooms" 
                       class="room-card"
                       [class.selected]="selectedRoom?.roomId === room.roomId"
                       (click)="selectRoom(room)">
                    <div class="room-header">
                      <span class="room-number">Room {{ room.roomNo }}</span>
                      <div class="occupancy-badge" 
                           [ngClass]="getOccupancyClass(room)">
                        {{ room.occupiedCount }}/{{ room.capacity }}
                      </div>
                    </div>
                    
                    <div class="room-progress">
                      <div class="progress-bar">
                        <div class="progress-fill" 
                             [style.width.%]="(room.occupiedCount / room.capacity) * 100"
                             [ngClass]="getOccupancyClass(room)"></div>
                      </div>
                    </div>
                    
                    <div class="room-actions">
                      <button nbButton ghost size="tiny" 
                              (click)="viewRoomDetails(room); $event.stopPropagation()">
                        <nb-icon icon="eye-outline"></nb-icon>
                      </button>
                      <button nbButton ghost size="tiny" 
                              (click)="assignStudentToRoom(room); $event.stopPropagation()">
                        <nb-icon icon="person-add-outline"></nb-icon>
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Selected Room Occupants -->
              <div *ngIf="selectedRoom" class="selected-room-details">
                <div class="details-header">
                  <h4>Room {{ selectedRoom.roomNo }} - Occupants ({{ occupants.length }})</h4>
                  <div class="header-actions">
                    <button nbButton ghost size="small" 
                            [status]="showPendingOnly ? 'primary' : 'basic'"
                            (click)="togglePendingFilter()">
                      <nb-icon icon="alert-circle-outline"></nb-icon>
                      Show Pending Only
                    </button>
                    <button nbButton ghost size="small" (click)="selectedRoom = null">
                      <nb-icon icon="close-outline"></nb-icon>
                    </button>
                  </div>
                </div>
                
                <div class="occupants-grid">
                  <div *ngFor="let student of filteredOccupants" 
                       class="occupant-card"
                       [class.temporary]="student.isTemporary"
                       [class.pending]="student.paymentStatus === 'Pending'"
                       nbTooltip="{{getStudentTooltip(student)}}"
                       nbTooltipPlacement="top"
                       nbTooltipStatus="primary">
                    
                    <div class="occupant-avatar" 
                         [ngClass]="student.gender?.toLowerCase()"
                         (click)="viewStudentQuick(student); $event.stopPropagation()">
                      <nb-icon icon="person-outline"></nb-icon>
                      <div class="online-indicator" [class.active]="!student.isTemporary"></div>
                    </div>
                    
                    <div class="occupant-info">
                      <span class="name" (click)="viewStudentQuick(student)">{{ student.fullName }}</span>
                      <span class="details">
                        {{ student.course }} â€¢ {{ student.phone || 'No Phone' }}
                      </span>
                      <div class="status-badges">
                        <span *ngIf="student.isTemporary" class="badge temporary">
                          <nb-icon icon="clock-outline"></nb-icon>
                          Temporary
                        </span>
                        <span *ngIf="student.paymentStatus === 'Pending'" class="badge pending">
                          <nb-icon icon="alert-circle-outline"></nb-icon>
                          Payment Due
                        </span>
                        <span *ngIf="!student.roomNo" class="badge noroom">
                          <nb-icon icon="home-outline"></nb-icon>
                          No Room
                        </span>
                      </div>
                    </div>
                    
                    <div class="occupant-actions">
                      <button nbButton ghost size="tiny" 
                              status="info"
                              nbTooltip="View Student Details"
                              nbTooltipPlacement="left"
                              (click)="viewStudentQuick(student); $event.stopPropagation()">
                        <nb-icon icon="eye-outline"></nb-icon>
                      </button>
                      <button nbButton ghost size="tiny" 
                              status="warning"
                              nbTooltip="Edit Student"
                              nbTooltipPlacement="left"
                              (click)="editStudent(student); $event.stopPropagation()">
                        <nb-icon icon="edit-outline"></nb-icon>
                      </button>
                      <button nbButton ghost size="tiny" 
                              status="success"
                              nbTooltip="Quick Actions"
                              nbTooltipPlacement="left"
                              [nbContextMenu]="studentContextMenu"
                              [nbContextMenuContext]="{ student: student }">
                        <nb-icon icon="more-vertical-outline"></nb-icon>
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Empty State -->
                <div *ngIf="filteredOccupants.length === 0" class="no-occupants">
                  <nb-icon icon="people-outline"></nb-icon>
                  <h5>No Occupants Found</h5>
                  <p *ngIf="showPendingOnly">No students with pending payments in this room</p>
                  <p *ngIf="!showPendingOnly">This room is currently empty</p>
                  <button nbButton status="primary" size="small" (click)="assignStudentToRoom(selectedRoom)">
                    <nb-icon icon="person-add-outline"></nb-icon>
                    Assign Student
                  </button>
                </div>
              </div>
            </div>
          </nb-card-body>
        </nb-card>

        <!-- Students Dashboard -->
        <nb-card class="dashboard-section" id="students-section">
          <nb-card-header class="section-header" (click)="toggleSection('students')">
            <div class="header-content">
              <div class="title-group">
                <nb-icon icon="people-outline" class="section-icon"></nb-icon>
                <h3>Student Dashboard</h3>
                <span class="badge">{{ students.length }} Students</span>
              </div>
              <nb-icon [icon]="collapsedSections.students ? 'chevron-down' : 'chevron-up'" 
                       class="toggle-icon"></nb-icon>
            </div>
          </nb-card-header>
          
          <nb-card-body *ngIf="!collapsedSections.students">
            <div class="dashboard-body">
              <!-- Student Metrics -->
              <div class="metrics-grid">
                <div class="metric-card" (click)="currentMonthAddmission()">
                  <div class="metric-icon admission">
                    <nb-icon icon="person-add-outline"></nb-icon>
                  </div>
                  <div class="metric-content">
                    <span class="value">{{ currentMonthAdmissions }}</span>
                    <span class="label">This Month</span>
                  </div>
                </div>
                
                <div class="metric-card" (click)="GetStudentbygender('Male')">
                  <div class="metric-icon male">
                    <nb-icon icon="person-outline"></nb-icon>
                  </div>
                  <div class="metric-content">
                    <span class="value">{{ maleCount }}</span>
                    <span class="label">Male Students</span>
                  </div>
                </div>
                
                <div class="metric-card" (click)="GetStudentbygender('Female')">
                  <div class="metric-icon female">
                    <nb-icon icon="person-outline"></nb-icon>
                  </div>
                  <div class="metric-content">
                    <span class="value">{{ femaleCount }}</span>
                    <span class="label">Female Students</span>
                  </div>
                </div>
                
                <div class="metric-card" (click)="showAllStudents()">
                  <div class="metric-icon total">
                    <nb-icon icon="people-outline"></nb-icon>
                  </div>
                  <div class="metric-content">
                    <span class="value">{{ students.length }}</span>
                    <span class="label">Total Students</span>
                  </div>
                </div>
              </div>

              <!-- Course Distribution -->
              <div class="course-distribution">
                <h4>Course Distribution</h4>
                <div class="course-cards">
                  <div *ngFor="let course of courses" 
                       class="course-card" 
                       (click)="GetStudentBycourse(course)">
                    <div class="course-info">
                      <span class="course-name">{{ course }}</span>
                      <span class="course-count">{{ courseWiseCount[course] }} students</span>
                    </div>
                    <div class="course-progress">
                      <div class="progress-bar">
                        <div class="progress-fill" 
                             [style.width.%]="(courseWiseCount[course] / students.length) * 100"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Students Table -->
              <div class="students-table-section">
                <div class="table-header">
                  <h4>Students List</h4>
                  <div class="table-actions">
                    <input type="text" 
                           [(ngModel)]="studentSearch" 
                           (input)="filterStudents()"
                           placeholder="Search students..." 
                           class="search-input">
                    <button nbButton status="success" size="small" (click)="openExportModal()">
                      <nb-icon icon="download-outline"></nb-icon> Export
                    </button>
                  </div>
                </div>
                
                <div class="table-container">
                  <table class="students-table">
                    <thead>
                      <tr>
                        <th>Name</th>
                        <th>Gender</th>
                        <th>Course</th>
                        <th>Phone</th>
                        <th>Room</th>
                        <th>Status</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let student of filteredStudents">
                        <td class="student-name">
                          <div class="avatar" [ngClass]="student.gender?.toLowerCase()">
                            <nb-icon icon="person-outline"></nb-icon>
                          </div>
                          {{ student.fullName }}
                        </td>
                        <td>
                          <span class="gender-badge" [ngClass]="student.gender?.toLowerCase()">
                            {{ student.gender }}
                          </span>
                        </td>
                        <td>{{ student.course }}</td>
                        <td>{{ student.phone || 'N/A' }}</td>
                        <td>
                          <span class="room-badge" *ngIf="student.roomNo">
                            {{ student.roomNo }}
                          </span>
                          <span class="no-room" *ngIf="!student.roomNo">-</span>
                        </td>
                        <td>
                          <span class="status-badge" 
                                [ngClass]="getStudentStatus(student)">
                            {{ getStudentStatus(student) }}
                          </span>
                        </td>
                        <td>
                          <button nbButton ghost status="info" size="tiny" 
                                  (click)="viewStudentQuick(student)">
                            <nb-icon icon="eye-outline"></nb-icon>
                          </button>
                          <button nbButton ghost status="warning" size="tiny" 
                                  (click)="editStudent(student)">
                            <nb-icon icon="edit-outline"></nb-icon>
                          </button>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </nb-card-body>
        </nb-card>

        <!-- Payments Dashboard -->
        <nb-card class="dashboard-section" id="payments-section">
          <nb-card-header class="section-header" (click)="toggleSection('payments')">
            <div class="header-content">
              <div class="title-group">
                <nb-icon icon="credit-card-outline" class="section-icon"></nb-icon>
                <h3>Payments Dashboard</h3>
                <span class="badge">{{ payments.length }} Payments</span>
              </div>
              <nb-icon [icon]="collapsedSections.payments ? 'chevron-down' : 'chevron-up'" 
                       class="toggle-icon"></nb-icon>
            </div>
          </nb-card-header>
          
          <nb-card-body *ngIf="!collapsedSections.payments">
            <div class="dashboard-body">
              <!-- Payment Metrics -->
              <div class="payment-metrics">
                <div class="payment-metric-card" (click)="loadPayments('today')">
                  <div class="metric-icon today">
                    <nb-icon icon="calendar-outline"></nb-icon>
                  </div>
                  <div class="metric-content">
                    <span class="value">{{ todayPaymentsCount }}</span>
                    <span class="label">Today</span>
                    <span class="amount">{{ getTodayAmount() | currency:'INR' }}</span>
                  </div>
                </div>
                
                <div class="payment-metric-card" (click)="loadPayments('month')">
                  <div class="metric-icon month">
                    <nb-icon icon="calendar-number-outline"></nb-icon>
                  </div>
                  <div class="metric-content">
                    <span class="value">{{ monthPaymentsCount }}</span>
                    <span class="label">This Month</span>
                    <span class="amount">{{ getMonthAmount() | currency:'INR' }}</span>
                  </div>
                </div>
                
                <div class="payment-metric-card" (click)="loadPayments('pending')">
                  <div class="metric-icon pending">
                    <nb-icon icon="clock-outline"></nb-icon>
                  </div>
                  <div class="metric-content">
                    <span class="value">{{ pendingPaymentsCount }}</span>
                    <span class="label">Pending</span>
                    <span class="amount">{{ getPendingAmount() | currency:'INR' }}</span>
                  </div>
                </div>
                
                <div class="payment-metric-card" (click)="loadPayments('due')">
                  <div class="metric-icon due">
                    <nb-icon icon="alert-circle-outline"></nb-icon>
                  </div>
                  <div class="metric-content">
                    <span class="value">{{ getDuePaymentsCount() }}</span>
                    <span class="label">Due Amount</span>
                    <span class="amount">{{ totalDueAmount | currency:'INR' }}</span>
                  </div>
                </div>
              </div>

              <!-- Payment Filters -->
              <div class="payment-filters">
                <div class="filter-group">
                  <input type="text" 
                         [(ngModel)]="paymentSearch" 
                         (input)="filterPayments()"
                         placeholder="Search payments..." 
                         class="search-input">
                </div>
                <div class="filter-buttons">
                  <button nbButton ghost size="small" 
                          [status]="currentPaymentFilter === 'all' ? 'primary' : 'basic'"
                          (click)="setPaymentFilter('all')">
                    All
                  </button>
                  <button nbButton ghost size="small" 
                          [status]="currentPaymentFilter === 'pending' ? 'primary' : 'basic'"
                          (click)="setPaymentFilter('pending')">
                    Pending
                  </button>
                  <button nbButton ghost size="small" 
                          [status]="currentPaymentFilter === 'completed' ? 'primary' : 'basic'"
                          (click)="setPaymentFilter('completed')">
                    Completed
                  </button>
                  <button nbButton ghost size="small" 
                          [status]="currentPaymentFilter === 'due' ? 'primary' : 'basic'"
                          (click)="setPaymentFilter('due')">
                    Due
                  </button>
                </div>
              </div>

              <!-- Payments Table -->
              <div class="payments-table-section">
                <div class="table-container">
                  <table class="payments-table">
                    <thead>
                      <tr>
                        <th *ngFor="let col of paymentColumns">{{ col.header }}</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let payment of filteredPayments" 
                          [class.pending]="payment.Status === 'Pending'"
                          [class.due]="payment.DueAmount > 0">
                        <td class="student-cell">
                          <div class="student-info">
                            <div class="avatar small">
                              <nb-icon icon="person-outline"></nb-icon>
                            </div>
                            {{ payment.StudentName }}
                          </div>
                        </td>
                        <td>{{ payment.PaymentDate | date:'mediumDate' }}</td>
                        <td>
                          <span class="payment-mode" [ngClass]="payment.PaymentMode?.toLowerCase()">
                            {{ payment.PaymentMode }}
                          </span>
                        </td>
                        <td class="amount paid">{{ payment.TotalAmount | currency:'INR' }}</td>
                        <td class="amount due">{{ payment.DueAmount | currency:'INR' }}</td>
                        <td>
                          <span class="status-badge" [ngClass]="payment.Status?.toLowerCase()">
                            {{ payment.Status }}
                          </span>
                        </td>
                        <td class="actions">
                          <button nbButton ghost size="tiny" status="info" 
                                  (click)="viewPayment(payment)">
                            <nb-icon icon="eye-outline"></nb-icon>
                          </button>
                          <button *ngIf="payment.Status === 'Pending'" 
                                  nbButton ghost size="tiny" status="success"
                                  (click)="verifyPayment(payment)">
                            <nb-icon icon="checkmark-outline"></nb-icon>
                          </button>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                
                <div *ngIf="filteredPayments.length === 0" class="no-data">
                  <nb-icon icon="credit-card-outline"></nb-icon>
                  <p>No payments found</p>
                </div>
              </div>
            </div>
          </nb-card-body>
        </nb-card>
      </div>
    </div>

    <!-- Student Context Menu -->
    <ng-template #studentContextMenu let-student="student">
      <nb-context-menu>
        <nb-menu tag="student-menu" [items]="studentMenuItems" [context]="{ student: student }"></nb-menu>
      </nb-context-menu>
    </ng-template>

    <!-- Student Quick View Modal -->
    <ng-template #studentQuickView let-student="student">
      <nb-card class="student-quick-modal">
        <nb-card-header>
          <div class="modal-header">
            <h4>Student Details</h4>
            <button nbButton ghost size="small" (click)="quickViewRef.close()">
              <nb-icon icon="close-outline"></nb-icon>
            </button>
          </div>
        </nb-card-header>
        <nb-card-body *ngIf="student">
          <div class="student-quick-view">
            <div class="student-header">
              <div class="avatar-large" [ngClass]="student.gender?.toLowerCase()">
                <nb-icon icon="person-outline"></nb-icon>
              </div>
              <div class="student-basic-info">
                <h3>{{ student.fullName }}</h3>
                <p class="student-course">{{ student.course }}</p>
                <div class="quick-stats">
                  <span class="stat" [ngClass]="getStudentStatus(student)">
                    {{ getStudentStatus(student) | titlecase }}
                  </span>
                  <span class="stat" [ngClass]="student.gender?.toLowerCase()">
                    {{ student.gender }}
                  </span>
                  <span class="stat" [ngClass]="student.isTemporary ? 'temporary' : 'permanent'">
                    {{ student.isTemporary ? 'Temporary' : 'Permanent' }}
                  </span>
                </div>
              </div>
            </div>
            
            <div class="student-details-grid">
              <div class="detail-item">
                <label><nb-icon icon="phone-outline"></nb-icon> Phone</label>
                <span>{{ student.phone || 'Not provided' }}</span>
              </div>
              <div class="detail-item">
                <label><nb-icon icon="email-outline"></nb-icon> Email</label>
                <span>{{ student.email || 'Not provided' }}</span>
              </div>
              <div class="detail-item">
                <label><nb-icon icon="home-outline"></nb-icon> Room</label>
                <span>{{ student.roomNo || 'Not assigned' }}</span>
              </div>
              <div class="detail-item">
                <label><nb-icon icon="calendar-outline"></nb-icon> Admission</label>
                <span>{{ student.admissionDate | date:'mediumDate' }}</span>
              </div>
              <div class="detail-item">
                <label><nb-icon icon="credit-card-outline"></nb-icon> Payment Status</label>
                <span [ngClass]="student.paymentStatus?.toLowerCase()">
                  {{ student.paymentStatus || 'Unknown' }}
                </span>
              </div>
              <div class="detail-item">
                <label><nb-icon icon="info-outline"></nb-icon> Status</label>
                <span [ngClass]="student.isActive ? 'active' : 'inactive'">
                  {{ student.isActive ? 'Active' : 'Inactive' }}
                </span>
              </div>
            </div>
            
            <div class="quick-actions">
              <button nbButton status="primary" size="small" (click)="editStudent(student); quickViewRef.close()">
                <nb-icon icon="edit-outline"></nb-icon>
                Edit Student
              </button>
              <button nbButton status="info" size="small" (click)="viewStudentLedger(student); quickViewRef.close()">
                <nb-icon icon="file-text-outline"></nb-icon>
                View Ledger
              </button>
              <button nbButton status="success" size="small" (click)="makePayment(student); quickViewRef.close()">
                <nb-icon icon="credit-card-outline"></nb-icon>
                Make Payment
              </button>
            </div>
          </div>
        </nb-card-body>
      </nb-card>
    </ng-template>

  </nb-layout-column>
</nb-layout>