<nb-card>
  <nb-card-header class="header-section">
    <div class="header-content">
      <span class="page-title">Students</span>
      <button nbButton status="success" size="small"
        (click)="router.navigate(['pages/master/students/add'])"
        class="add-button">
        <nb-icon icon="plus-outline"></nb-icon>
        Add Student
      </button>
    </div>
  </nb-card-header>

  <nb-card-body>
    <!-- ðŸ” Search Section -->
    <div class="search-section">
      <div class="search-input-group">
        <nb-icon icon="search-outline" class="search-icon"></nb-icon>
        <input nbInput placeholder="Search by name, email, phone, course" 
               [(ngModel)]="searchQuery" 
               class="search-input"
               (keyup.enter)="search()">
      </div>
      <div class="search-buttons">
        <button nbButton status="info" size="small" (click)="search()" class="search-btn">
          <nb-icon icon="search-outline"></nb-icon>
          Search
        </button>
        <button nbButton status="basic" size="small" (click)="clearSearch()" class="reset-btn">
          <nb-icon icon="refresh-outline"></nb-icon>
          Reset
        </button>
      </div>
    </div>

    <div class="ledger-wrapper" [class.ledger-open]="ledgerStudent">
      <!-- ðŸ§ Student List -->
      <div class="students-col">
        <div class="students-header">
          <h4>Student List</h4>
          <span class="student-count">{{filteredStudents.length}} students</span>
        </div>
        
        <div class="student-card" *ngFor="let student of filteredStudents" 
             [class.active]="ledgerStudent?.studentId === student.studentId">
          <div class="card-grid">
            <div class="student-info-col">
              <h4 class="student-name">{{student.fullName}}</h4>
              <div class="info-grid">
                <div class="info-item">
                  <nb-icon icon="book-outline" class="info-icon"></nb-icon>
                  <label>Course:</label> 
                  <span class="course-name">{{student.courseName}}</span>
                </div>
                <div class="info-item">
                  <nb-icon icon="email-outline" class="info-icon"></nb-icon>
                  <label>Email:</label> 
                  <span class="email">{{student.email}}</span>
                </div>
                <div class="info-item">
                  <nb-icon icon="phone-outline" class="info-icon"></nb-icon>
                  <label>Phone:</label> 
                  <span class="phone">{{student.phone}}</span>
                </div>
                <div class="info-item" *ngIf="student.roomNo">
                  <nb-icon icon="home-outline" class="info-icon"></nb-icon>
                  <label>Room:</label> 
                  <span class="room-no">{{student.roomNo}}</span>
                </div>
              </div>

              <div class="card-actions">
                <button nbButton status="primary" size="tiny" 
                        (click)="edit(student); $event.stopPropagation()"
                        class="action-btn">
                  <nb-icon icon="edit-outline"></nb-icon>
                  Edit
                </button>
                <button nbButton status="danger" size="tiny" 
                        (click)="delete(student); $event.stopPropagation()"
                        class="action-btn">
                  <nb-icon icon="trash-2-outline"></nb-icon>
                  Delete
                </button>
                <button nbButton status="info" size="tiny" 
                        (click)="loadLedger(student); $event.stopPropagation()"
                        class="action-btn">
                  <nb-icon icon="file-text-outline"></nb-icon>
                  View Ledger
                </button>
              </div>
            </div>

            <div class="student-photo-col">
              <!-- Photo frame - Only load when clicked -->
              <div class="photo-frame" (click)="loadAndEnlargePhoto(student)">
                <img
                  *ngIf="studentPhotos[student.studentId]"
                  [src]="studentPhotos[student.studentId]"
                  class="student-photo"
                  alt="Student Photo"
                />
                <div *ngIf="!studentPhotos[student.studentId]" class="photo-placeholder">
                  <nb-icon icon="person-outline"></nb-icon>
                  <span>Click to view</span>
                </div>
              </div>
            
              <!-- Small icon buttons below -->
              <div class="photo-actions">
                <button nbButton ghost size="tiny" status="primary" 
                        title="Upload Photo" 
                        (click)="triggerFileInput(student); $event.stopPropagation()">
                  <nb-icon icon="upload-outline"></nb-icon>
                </button>
                <button nbButton ghost size="tiny" status="info" 
                        title="Enlarge Photo" 
                        (click)="loadAndEnlargePhoto(student); $event.stopPropagation()">
                  <nb-icon icon="expand-outline"></nb-icon>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Empty State -->
        <div class="empty-state" *ngIf="filteredStudents.length === 0">
          <nb-icon icon="people-outline" class="empty-icon"></nb-icon>
          <h4>No Students Found</h4>
          <p>No students match your search criteria.</p>
        </div>
      </div>

      <!-- ðŸ“œ Ledger View -->
      <div class="ledger-col" *ngIf="ledgerStudent">
        <!-- Mobile Back Button -->
        <div class="mobile-back-button" (click)="closeLedger()">
          <nb-icon icon="arrow-back-outline"></nb-icon>
          <span>Back to Students</span>
        </div>
        
        <div class="ledger-header">
          <div class="ledger-title">
            <h4>Student Ledger</h4>
            <p class="student-name">{{ledgerStudent.fullName}}</p>
          </div>
          <button nbButton ghost size="small" (click)="closeLedger()" class="close-ledger">
            <nb-icon icon="close-outline"></nb-icon>
          </button>
        </div>

        <div class="date-filter">
          <div class="filter-group">
            <label>From Date:</label>
            <input nbInput type="date" [(ngModel)]="fromDate" class="date-input">
          </div>
          <div class="filter-group">
            <label>To Date:</label>
            <input nbInput type="date" [(ngModel)]="toDate" class="date-input">
          </div>
          <div class="filter-actions">
            <button nbButton status="info" size="small" (click)="onDateChange()" class="load-btn">
              <nb-icon icon="refresh-outline"></nb-icon>
              Load
            </button>
            <button nbButton status="success" size="small" (click)="exportLedgerPdf()" class="export-btn">
              <nb-icon icon="download-outline"></nb-icon>
              Export PDF
            </button>
          </div>
        </div>

        <!-- Ledger Summary -->
        <div class="ledger-summary" *ngIf="ledgerEntries.length">
          <div class="summary-item">
            <span class="summary-label">Total Debit</span>
            <span class="summary-value debit">{{getTotalDebit() | currency:'INR'}}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Total Credit</span>
            <span class="summary-value credit">{{getTotalCredit() | currency:'INR'}}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Current Balance</span>
            <span class="summary-value balance" 
                  [class.positive]="getCurrentBalance() >= 0"
                  [class.negative]="getCurrentBalance() < 0">
              {{getCurrentBalance() | currency:'INR'}}
            </span>
          </div>
        </div>

        <div class="ledger-table-container">
          <div class="ledger-table" *ngIf="ledgerEntries.length; else noLedger">
            <div class="ledger-row ledger-header">
              <div>Date</div>
              <div>Type</div>
              <div>Particulars</div>
              <div>Debit</div>
              <div>Credit</div>
              <div>Balance</div>
            </div>

            <div class="ledger-row"
                 *ngFor="let entry of ledgerEntries"
                 [ngClass]="{
                   'type-payment': entry.type === 'PAYMENT',
                   'type-adjustment': entry.type === 'PAYMENT_ADJUSTMENT',
                   'type-charge': entry.type === 'ADDITIONAL_CHARGE',
                   'type-advance': entry.type === 'ADVANCE_PAYMENT'
                 }">
              <div class="date-cell">{{entry.date | date:'dd-MMM-yyyy'}}</div>
              <div class="type-cell">
                <span class="type-badge" [ngClass]="'badge-' + entry.type?.toLowerCase()">
                  {{entry.type}}
                </span>
              </div>
              <div class="particulars-cell">{{entry.particulars || entry.description}}</div>
              <div class="debit-cell">{{entry.debit ? (entry.debit | number:'1.2-2') : ''}}</div>
              <div class="credit-cell">{{entry.credit ? (entry.credit | number:'1.2-2') : ''}}</div>
              <div class="balance-cell">{{entry.balance ? (entry.balance | number:'1.2-2') : ''}}</div>
            </div>
          </div>

          <ng-template #noLedger>
            <div class="no-ledger-data">
              <nb-icon icon="file-text-outline" class="no-data-icon"></nb-icon>
              <h4>No Ledger Data</h4>
              <p>No financial records found for the selected period.</p>
            </div>
          </ng-template>
        </div>
      </div>
    </div>
  </nb-card-body>
</nb-card>

<ng-template #photoModal let-data>
  <nb-card class="photo-modal">
    <nb-card-header>
      <span>Student Photo</span>
      <button nbButton ghost size="small" (click)="dialogRef?.close()">
        <nb-icon icon="close-outline"></nb-icon>
      </button>
    </nb-card-header>
    <nb-card-body class="photo-modal-body">
      <img [src]="data" *ngIf="data" class="enlarged-photo">
      <div class="no-photo" *ngIf="!data">
        <nb-icon icon="image-outline"></nb-icon>
        <p>No photo available</p>
      </div>
    </nb-card-body>
  </nb-card>
</ng-template>