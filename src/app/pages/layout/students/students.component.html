<nb-card>
  <nb-card-header class="header-section">
    <span>Students</span>
    <button nbButton status="success" size="small"
      (click)="router.navigate(['pages/master/students/add'])"
      class="add-button">
      Add Student
    </button>
  </nb-card-header>

  <nb-card-body>
    <!-- 🔍 Search Section -->
    <div class="search-section">
      <input nbInput placeholder="Search by name, email, phone" [(ngModel)]="searchQuery" class="search-input">
      <div class="search-buttons">
        <button nbButton status="info" size="tiny" (click)="search()">Search</button>
        <button nbButton status="secondary" size="tiny" (click)="clearSearch()">Reset</button>
      </div>
    </div>

    <div class="ledger-wrapper">
      <!-- 🧍 Student List -->
      <div class="students-col">
        <div class="student-card" *ngFor="let student of filteredStudents">
          <div class="card-grid">
            <div class="student-info-col">
              <h4>{{student.fullName}}</h4>
              <div class="info-item"><label>Course:</label> <span>{{student.courseName}}</span></div>
              <div class="info-item"><label>Email:</label> <span>{{student.email}}</span></div>
              <div class="info-item"><label>Phone:</label> <span>{{student.phone}}</span></div>

              <div class="card-actions">
                <button nbButton status="primary" size="tiny" (click)="edit(student); $event.stopPropagation()">Edit</button>
                <button nbButton status="danger" size="tiny" (click)="delete(student); $event.stopPropagation()">Delete</button>
                <button nbButton status="info" size="tiny" (click)="loadLedger(student); $event.stopPropagation()">View Ledger</button>
              </div>
            </div>

            <div class="student-photo-col">
              <div class="photo-frame"
                   (click)="enlargePhoto(student); $event.stopPropagation()"
                   [title]="'Click to enlarge'">
                <img *ngIf="studentPhotos[student.studentId]; else noPhoto"
                     [src]="studentPhotos[student.studentId]"
                     class="student-photo">
                <ng-template #noPhoto>
                  <div class="photo-placeholder">Click to view</div>
                </ng-template>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 📜 Ledger View -->
      <div class="ledger-col" *ngIf="ledgerStudent">
        <h4>Ledger - {{ledgerStudent.fullName}}</h4>

        <div class="date-filter">
          <label>From:</label>
          <input type="date" [(ngModel)]="fromDate">
          <label>To:</label>
          <input type="date" [(ngModel)]="toDate">
          <button nbButton status="info" size="tiny" (click)="onDateChange()">Load</button>
          <button nbButton status="success" size="tiny" (click)="exportLedgerPdf()">Export PDF</button>
        </div>

        <div class="ledger-table" *ngIf="ledgerEntries.length; else noLedger">
          <div class="ledger-row ledger-header">
            <div>Date</div>
            <div>Type</div>
            <div>Particulars</div>
            <div>Debit</div>
            <div>Credit</div>
            <div>Balance</div>
          </div>

          <div class="ledger-row"
               *ngFor="let entry of ledgerEntries"
               [ngClass]="{
                 'type-payment': entry.type === 'PAYMENT',
                 'type-adjustment': entry.type === 'PAYMENT_ADJUSTMENT',
                 'type-charge': entry.type === 'ADDITIONAL_CHARGE',
                 'type-advance': entry.type === 'ADVANCE_PAYMENT'
               }">
            <div>{{entry.date | date:'dd-MMM-yyyy'}}</div>
            <div>{{entry.type}}</div>
            <div>{{entry.particulars || entry.description}}</div>
            <div>{{entry.debit ? (entry.debit | number:'1.2-2') : ''}}</div>
            <div>{{entry.credit ? (entry.credit | number:'1.2-2') : ''}}</div>
            <div>{{entry.balance ? (entry.balance | number:'1.2-2') : ''}}</div>
          </div>
        </div>

        <ng-template #noLedger>
          <div style="text-align:center; margin-top:20px;">No ledger data available.</div>
        </ng-template>
      </div>
    </div>
  </nb-card-body>
</nb-card>

<!-- 📸 Enlarged Photo Modal -->
<nb-dialog *ngIf="enlargedPhotoUrl" (close)="enlargedPhotoUrl=null">
  <img [src]="enlargedPhotoUrl" style="width:100%; max-width:400px; border-radius:8px;">
</nb-dialog>
