<nb-card>
  <!-- Header -->
  <nb-card-header>{{ payment ? 'Edit Payment' : 'New Payment' }}</nb-card-header>

  <!-- Form Body -->
  <nb-card-body [formGroup]="form">
    <!-- Student Selection -->
    <div class="form-grid">
      <div class="form-item">
        <label>Student</label>
        <nb-select formControlName="studentId" placeholder="Select student">
          <nb-option *ngFor="let s of students" [value]="s.studentId">
            {{ s.fullName }} ({{ s.studentId }})
          </nb-option>
        </nb-select>
      </div>
    </div>

    <!-- Payment Details -->
    <div class="form-grid">
      <div class="form-item">
        <label>Payment Date</label>
        <input nbInput type="date" formControlName="paymentDate" />
      </div>
      <div class="form-item">
        <label>Payment Type</label>
        <nb-select formControlName="paymentType">
          <nb-option value="BILL">Bill</nb-option>
          <nb-option value="ADVANCE">Advance</nb-option>
          <nb-option value="OLD">Old</nb-option>
        </nb-select>
      </div>
      <div class="form-item">
        <label>Payment Mode</label>
        <nb-select formControlName="paymentMode">
          <nb-option value="Cash">Cash</nb-option>
          <nb-option value="Cheque">Cheque</nb-option>
          <nb-option value="UPI">UPI</nb-option>
        </nb-select>
      </div>
    </div>

    <!-- Amount & Remarks -->
    <div class="form-grid">
      <div class="form-item">
        <label>Total Paying Amount</label>
        <input nbInput type="number" formControlName="totalAmount" />
      </div>
      <div class="form-item">
        <label>Reference</label>
        <input nbInput type="text" formControlName="referenceNumber" />
      </div>
      <div class="form-item">
        <label>Remarks</label>
        <input nbInput type="text" formControlName="remarks" />
      </div>
    </div>

    <!-- Pending Bills -->
    <div class="mt-3" *ngIf="form.get('paymentType')?.value === 'BILL'">
      <nb-card>
        <nb-card-header>
          Pending Bills
          <button nbButton size="small" status="info" style="float:right"
                  (click)="loadPendingBills(form.value.studentId)">Reload</button>
        </nb-card-header>
        <nb-card-body>
          <div class="table-responsive">
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th>Room No</th>
                  <th>Period</th>
                  <th>Bill</th>
                  <th>Balance</th>
                  <th>Adjust</th>
                </tr>
              </thead>
              <tbody formArrayName="billAdjustments">
                <tr *ngFor="let b of billAdjArray.controls; let i = index" [formGroupName]="i">
                  <td>{{ b.value.roomNo }}</td>
                  <td>{{ b.value.period }}</td>
                  <td>{{ b.value.billAmount | currency }}</td>
                  <td>{{ b.value.balance | currency }}</td>
                  <td>
                    <input nbInput type="number" formControlName="adjustedAmount"
                           (input)="onManualAdjustChanged()" />
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </nb-card-body>
      </nb-card>
    </div>

    <!-- Additional Charges -->
    <div class="mt-3" *ngIf="form.get('paymentType')?.value === 'BILL'">
      <nb-card>
        <nb-card-header>
          Additional Charges
          <button nbButton size="small" status="success" style="float:right" (click)="addCharge()">Add Charge</button>
        </nb-card-header>
        <nb-card-body>
          <div formArrayName="additionalCharges">
            <div *ngFor="let ch of additionalCharges.controls; let i=index" [formGroupName]="i" class="charge-grid">
              <nb-select formControlName="expenseHeadId" placeholder="Head">
                <nb-option *ngFor="let head of expenseHeads" [value]="head.Id">{{ head.Name }}</nb-option>
              </nb-select>
              <input nbInput type="number" formControlName="amount" placeholder="Amount" />
              <input nbInput type="text" formControlName="remarks" placeholder="Remarks" />
              <button nbButton size="tiny" status="danger" (click)="removeCharge(i)">Remove</button>
            </div>
          </div>
        </nb-card-body>
      </nb-card>
    </div>
  </nb-card-body>

  <!-- Footer Buttons -->
  <nb-card-footer>
    <button nbButton status="primary" (click)="save()">Save</button>
    <button nbButton status="danger" (click)="cancel()">Cancel</button>
  </nb-card-footer>
</nb-card>
